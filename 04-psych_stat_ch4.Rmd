# 第4章 確率モデルと標本分布 {-}

## 4.1.1 比率の標本分布(p.93-97)  {-} 

- 教科書(4.2)式であらわされる確率分布は**2項分布**でした。  
- 2項分布は一般的には「成功確率が$\pi$の試行を独立に$N$回繰り返したときの成功数$w$の確率を与える分布」です。  
- 教科書95ページにある例をもとにRで確率の計算を行ってみましょう。  

### 手順1  {-} 

- 教科書95ページでは$N = 5$，$\pi = .6$としたときのサンプルにおける正答者数が$0, 1, 2, 3 ,4, 5$の各値をとる確率を計算しています。  
- $N$, $\pi$, $w$の値をそれぞれ`N`, `PI`, `w`というオブジェクトに代入します。 
- `w`には，まず正答者数が0の時の値を計算できるように数字の0を代入してください。  

```{r}
N <- 5
PI <- 0.6
w <- 0
``` 

<br>

### 手順2  {-} 

- 次に(4.2)式をコードで記述します。  
- (4.2)式はこのような数式でした。 

$$
\begin{align}
f(w) &= {}_N C _w \pi ^{w}(1 - \pi) ^{N - w}\\
&= \frac{N!}{w!(N - w)!} \pi ^{w}(1 - \pi) ^{N - w}\tag{4.2}
\end{align}
$$  

<div class="alert alert-info">
(4.2)式には「!(階乗)」があります。Rでは階乗の計算は`gamma(N + 1)`で行うことができます。
</div>  

- 例えば3の階乗($3!$)は`3 * 2 * 1`で6です。  
- コンソール画面に`gamma(3 + 1)`と直接入力すると同様に6と計算できるはずです。確認してみてください。 
- (4.2)式をコードで記述すると以下のようになります。  

```{r}
gamma(N + 1) / (gamma(w + 1) * gamma(N - w + 1)) * PI ^w * (1 - PI) ^(N - w)
```  

- 実行すると`r gamma(N + 1) / (gamma(w + 1) * gamma(N - w + 1)) * PI ^w * (1 - PI) ^(N-w)`という結果が表示されます。  
- これは正答者数が0(`w` = 0)のときの確率です。  
- 教科書でも$f(0) = .4 ^5 = .01024$と同じ値が計算されていることがわかります。  

<details>
<summary>
補足(クリックすると説明が表示されます)
</summary>
- Rを電卓がわりに計算することもできます。  
- 0.4の5乗は以下のコードで計算することができます。  

```{r}
0.4 ^ 5
```  
</details>

<br>

### 手順3  {-} 

- `w`に0から5の値を代入して，一度に確率が計算できるようにします。  
- Rでは複数の値を1つのベクトルとしてまとめることができます。ベクトルを作成するには`c()`関数を用います。  
- `w`の中身を確認すると，0から5の値が代入されていることが確認できます。  

```{r}
w <- c(0, 1, 2, 3, 4, 5)
w
```  

- 上記のコードを実行したら，以下の(4.2)式のコードを再度実行してください。それぞれの正答者数に対応した確率が計算されます。    

```{r}
gamma(N + 1) / (gamma(w + 1) * gamma(N - w + 1)) * PI ^w * (1 - PI) ^(N - w)
```  

- $0.01024$は正答者数が0($f(0)$)の時，$0.07680$は正答者数が1($f(1)$)の時にそれぞれ対応します。  

<br>

### 手順4 {-}  

- 最後に計算した確率を図で表現してみましょう。  
- 図で表すため，(4.2)式のコードを`x`というオブジェクトに代入します。  
- 図4-3のような棒グラフを描くには，`barplot()`関数を使います。  
- 引数のうち，`ylab`はy軸のラベル，`main`は図のタイトル，`names.arg`は各バーの名前を設定しています。  

<div class="alert alert-info">
- Macだとプロットするときに日本語が文字化けすることがあります。その時は，`par(family= "HiraKakuProN-W3")`というコードを入力し実行してから，再度`barplot()`関数を実行してください。  
</div>  

```{r fig10, fig.align="center"}
x <- gamma(N + 1) / (gamma(w + 1) * gamma(N - w + 1)) * PI ^w * (1 - PI) ^(N - w)

barplot(x, ylab = "確率", main = "正答者wおよび比率pの標本分布",
	names.arg = c(0,1,2,3,4,5))
```  




## 4.1.2 確率分布の平均(p.97-98)  {-} 

- 確率分布の平均$\mu$は(4.4)式のように定義されます。  
  - ただし，(離散型)確率変数$x$がとりうる値を$x _{1}, \cdots, x _{m}$とし，それぞれの値をとる確率を$f(x _{k})$とする。  

$$
\mu = \sum ^{m} _{k = 1} x _{k} f(x _{k})\tag{4.4}\\
$$  

- 図4-3の正答者数$w$の標本分布(試行数$N = 5$，成功確率$\pi = .6$の2項分布)の平均$\mu _{w}$を計算しましょう。  
  - 平均$\mu _{w}$は$w$の期待値$E(w)$とも表記します。 
<br>

- (4.4)式をコードで記述すると以下になります。

<div class="alert alert-info">
- オブジェクト`x`には先ほど求めた確率の値(`r round(x, 3)`)，`w`には正答者数である0から5の数字(`r w`)が代入されています。  
<br>
- $\sum$は総和記号(シグマ)を表し，Rでは`sum()`関数で計算することができます。  
<br>
- 手計算を行う際には，$x _{1}$と$f(x _{1})$の掛け算，...，$x _{k}$と$f(x _{k})$の掛け算を行い足し合わせることを行いますが，Rではベクトル同士の掛け算が可能なので，`x * w`で一度に掛け算をすることが可能です。コンソールに`x * w`と直接入力すると掛け算の結果が確認できます。  
</div>  

```{r}
sum(x * w)
```  

<br>

- 2項分布に従う確率変数である正答者数$w$の標本分布の平均は(4.5)式のように定義されます。  

$$
\mu _{w} =N \pi\tag{4.5}\\ 
$$  

- (4.5)式をRで記述します。  

<div class="alert alert-info">
オブジェクト`N`には試行数の5，`PI`には成功確率である0.6が代入されています。  
</div>  

```{r}
N * PI
```  

- 期待値の定義から計算しても，2項分布の期待値にしたがって計算しても同じ結果が得られていることが確認できます。   

## 4.1.3 比率の標本分布の平均(p.98-99)  {-} 

- (4.6)式をコードで記述すると以下のようになります。  

```{r}
(N * PI) / N
```

- 標本統計量の分布の平均(期待値)が，その統計量によって推定しようとしている母数の値に一致するとき，<u>**不偏性**</u>を持つといいます。  
<br>
- 実際に正答者の比率$p$が母集団比率$\pi$に一致するか，Rを使ったシミュレーションで確認してみましょう。  
- シミュレーションの手順は以下の通りです。  
  1. 試行数$N = 5$，母集団比率$\pi = .6$の2項分布に従うサンプル(=正答者$w$)を1000個発生させる。  
  1. 得られた1000個の乱数の比率$p$をそれぞれ計算し，比率$p$の平均(=標本統計量の分布の期待値)が母集団平均$\pi = .6$に一致するか確認します。  
<br>

- 具体的なイメージとしては，5人の中学生1年生が小学校で習うある分数の計算問題を正しく解くことができるか，という場面を想定します。  

- 5人の中学生のうち何人が正しく解けるか比率$p$を計算し，それを1000校で行った結果，1000校分の比率$p$を平均すると母集団比率$\pi = .6$になるかを確認します。  

<br>

<br>
- シミュレーションを行うコードは以下の通りです。  

<div class="alert alert-info">
`rbinom()`関数は2項分布に従う乱数を発生することができる関数です。`rbinom(発生させる乱数の数, 試行数, 成功確率)`で2項分布に従う乱数を発生させます。今回は乱数の数が1000，試行数$N = 5$，成功確率(母集団比率)$\pi = .6$を設定します。  
</div>  


### 手順1 {-}

- 試行数$N = 5$，母集団比率$\pi = .6$の2項分布に従うサンプルを1000個発生させ，`bin_sample`というオブジェクトに代入し，比率を計算します(`bin_sample`は1000個あるので，初めの10個のみ表示しています)。  

```{r}
set.seed(1234)
bin_sample <- rbinom(1000, 5, 0.6)
head(bin_sample, n = 10)
```  

### 手順2 {-}  

- `bin_sample`の比率を求め，平均値を求める  

```{r}
bin_sample / 5
mean(bin_sample / 5)
```  

- 母集団比率$\pi = .6$に近い値が得られることが確認できます。  

## 4.1.4 確率分布の標準偏差(p.99-100)  {-} 

- 試行数$N = 5$，母集団比率$\pi = .6$の例で，(4.7)式を計算してみましょう。  
- (4.7)式は以下のように定義されます。  

$$
\sigma = \sqrt{\sum ^{m} _{k = 1}(x _ {k} - \mu) ^{2} f(x _{k})} \tag{4.7}\\
$$  

- (4.7)式をコードで記述すると以下のようになります。  

<div class="alert alert-info">
これまでの計算で，$\mu$($\mu_{w}$)はRコードで`N * PI`と記述できます。`sqrt()`関数は平方根を計算する関数です。square rootの略と覚えましょう。      
</div>  

```{r}
sqrt(sum((w - N * PI)^2 * x))
```  

- また，(4.7)式を変形させた(4.8)式をコードで記述すると以下になります。  

```{r}
sqrt(N * PI * (1 - PI))
```  

- 同様の結果が得られていることが確認できます。  

## 4.1.5 比率の標本分布の標準偏差(p.100) {-}  

- 標本統計量の標準偏差は，その統計量の**標準誤差**と呼ばれます。  
- 比率$p$の標本分布の標準偏差(=標準誤差)は(4.9)式です。  

$$
\sigma _{p} = \sqrt{\frac{\pi(1 - \pi)}{N}}\tag{4.9}\\
$$  

- (4.9)式を図4-3の例を使って，Rコードで計算してみましょう。  

```{r}
sqrt(PI * (1 - PI) / N)
```  

- 教科書p.100の計算結果と同じになっていることがわかります。

## 4.1.6 標準誤差に基づくサンプルサイズの決定(p.101-102)  {-} 

- 図4.4を実際に書いてみましょう。  
- まずは標準誤差を計算する関数を定義します(関数の定義する`function()`関数は説明していないので理解する必要はありません)。  
- 標準誤差を計算する関数を`Standard.error()`関数という名前で定義します。  
<br>

<div class="alert alert-info">
- 関数の中身は(4.9)式をコードで表したものです。  
- 初めの引数には試行数`N`，2番目の引数には成功確率`PI`を指定します。よって，`N`と`PI`に様々な値を与えることで，標準誤差を計算することが可能になります。  
- 関数を定義することで様々な値で標準誤差を計算するときに各コードが短く済むので便利です。      
</div>  

```{r}
Standard.error <- function(N, PI){
  sqrt(PI * (1 - PI) / N)
}
```  

- $N = 5$，$\pi = .6$の時の結果を確認してみましょう。  

```{r}
Standard.error(5, 0.6)
```  

- 2.5比率の標本分布の標準偏差で計算した値と一致していることを確認してください。   
<br>

<br>

- それでは図4.4を描写していきます。  

<div class="alert alert-info">
- はじめのコードでは，`PI`というオブジェクトに0から1まで0.01刻みのベクトルを作成します。  
<br>
  - 0から1の範囲で細かい点を作成し，それぞれの点に対応する標準誤差の値を計算することで，最終的に点と点を線でつなぎ，グラフを作成することを行っています。  
<br>
- `plot()`関数では，先ほど定義した`Standard.error()`関数を用いて計算結果を描写しています。  
<br>
  - 引数のうち，`type = "l"`は値を線でつないだ図を描くことを指定します。
  <br>
- `lines()`関数は元ある図の上に上書きをする関数です。  
<br>
- (注意)`lines()`関数を用いたコードは，コード単体で実行するとエラーが出ます(上書きをするため，元の図画がないといけない)。<u>**ここのブロックのコード(`PI <- ...` から`lines(...)`まで)はドラッグで複数のコードを全部選択して一度に実行するようにしてください。**</u>  
- Macだとプロットするときに日本語が文字化けすることがあります。その時は，`par(family= "HiraKakuProN-W3")`というコードを入力し実行してから，再度コードをを実行してください。  
</div>  

```{r fig11, fig.align="center"}
PI <- seq(0,1,by = 0.01)
plot(Standard.error(1, PI) ~ PI, type = "l", xlab = "母集団比率", ylab = "標準誤差", main = "標本比率pの標準誤差")
lines(Standard.error(3, PI) ~ PI)
lines(Standard.error(10, PI) ~ PI)	
lines(Standard.error(100, PI) ~ PI)
```  

- 標準誤差.05以下に抑えたい場合の標本サイズを計算してみましょう。  
- 教科書p.101にある(4.9)式を使った式を展開します。  

$$
\begin{align}
\sigma _{p} = \sqrt(\frac{\pi(1 - \pi)}{N}) &\leq .05\\
\frac{\pi(1 - \pi)}{N} &\leq .05 ^{2}\\
\pi(1 - \pi) &\leq .05 ^{2} \times N\\
\frac{1}{.05 ^{2}} \pi(1 - \pi) &\leq N\\
\end{align}
$$  

- 最後の式の左辺をコードで記述すると以下のようになります(ただし，$\pi$は教科書にある通り0.5を代入します)。  

```{r}
(1 / (0.05)^2) * 0.5 * (1 - 0.5)
```  

- 教科書と同様100という結果が得られました。  

## 4.1.7 逸脱行動データにおける比率の変動(p.102-103)  {-} 

- 逸脱行動データを`dat`というオブジェクトに読み込みます。  

```{r}
dat <- read.csv(file = "data/itsudatsu_data.csv")	
dat
```  

- 小6から中2への逸脱行動得点の変化量が3以上の被験者を抽出  
  - 男子を`itsu_M`，女子を`itsu_F`というオブジェクトに代入  
<br>  

<div class="alert alert-info">
- `subset()`関数は条件式に基づいてデータを抽出する関数  
<br>
  - 詳しい使い方は`?subset()`とコンソールに入力してヘルプで確認してください。  
</div>

- 変化量が3以上の男子  
```{r}
itsu_M <- subset(dat, sex == 1 & diff >= 3)
itsu_M
```  

- 変化量が3以上の女子  

```{r}
itsu_F <- subset(dat, sex == 2 & diff >= 3)
itsu_F
```  

- 男子は20人中9人，女子は20人中15人いることがわかります。  
<br>

<br>

- 比率の標準誤差を計算してみましょう。  
- (4.9)式を用いて標準誤差を求めるには母集団比率$\pi$の値が必要となります。  
  - 標本比率をそれぞれの母集団比率の推定値として用います。  

- 男子と女子の標本比率を計算し，`itsu_M_p`，`itsu_F_p`というオブジェクトに代入します。  

```{r}
itsu_M_p <- nrow(itsu_M) / 20
itsu_M_p
itsu_F_p <- nrow(itsu_F) / 20
itsu_F_p
``` 
  
- 男子における比率の標準誤差の推定値  

```{r}
sqrt(itsu_M_p * (1 - itsu_M_p) / 20)
```   

- 女子における比率の標準誤差の推定値  

```{r}
sqrt(itsu_F_p * (1 - itsu_F_p) / 20)
```  

- 教科書と同様の値が得られていることを確認してください。  

## 4.2.1 正規分布の確率の求め方(p.106-109) {-}

### 確率密度関数を積分する方法  {-}   

- 正規分布の確率密度関数((4.10)式)をおさらいしましょう。  

$$
f(x) = \frac{1}{\sqrt{2\pi}\sigma} \exp \left[ - \frac{(x - \mu) ^{2}}{2 \sigma ^{2}}\right]\tag{4.10}\\
$$  

- いま，平均0，標準偏差1の標準正規分布に従う確率変数$z$について考えます。  

- 標準正規分布の確率密度関数は，(4.10)式に$\mu = 0$，$\sigma = 1$を代入すればよいので，  

$$
f(z) = \frac{1}{\sqrt{2\pi}} \exp \left[ - \frac{z ^{2}}{2}\right]\\
$$  

となります。  

- 上記の式を使って$Prob(0 < z < 1.96)$を計算してみましょう。  
- 標準正規分布の確率密度関数を0から1.96の範囲で積分すれば$Prob(0 < z < 1.96)$を計算することができます((4.11)式を確認)。  
<br>
- まずは標準正規分布の確率密度関数を`stand.norm()`関数として定義しましょう。  
  - 引数は式の通り`z`の1つを取ります。正規分布の確率密度関数における$\pi$は円周率を表します。  
  - Rでは円周率は`pi`というオブジェクトにあらかじめ代入されています。コンソールに直接`pi`と入力すると確認できます。  

```{r}
stand.norm <- function(z){
  (1 / sqrt(2 * pi)) * exp((-z ^2) / 2)
}
```  

- 0から1.96の範囲で標準正規分布の確率密度関数(`stand.norm()`関数)を積分します。  
- Rで積分を行うには`integrade()`関数を使います。  
  - `integrade()`関数は，第一引数に積分する関数，第二引数の`lower`に積分する範囲の下限，第三引数の`upper`に上限を与えることで積分を行います。  

```{r}
integrate(stand.norm, lower = 0, upper = 1.96)
```  

- 0から1.96で積分を行うことで0.475...という確率が計算できました。

### `pnorm()`関数を使った計算方法  {-} 

- 手順1では実際に標準正規分布の確率密度関数を定義し，積分を行うことで確率の計算を行いました。  
- Rには正規分布に関して，便利な関数があらかじめ用意されています。  
<br>
- $Prob(0 < z < 1.96)$は，正規分布の累積分布関数をあらわす`pnorm()`関数を用いて計算することができます。
  - 累積分布関数は，$-\infty$からある値までの確率を計算します。  
- $Prob(0 < z < 1.96)$の計算方法は，$-\infty$から$z = 1.96$までの確率から，$-\infty$から$z = 0$の範囲までの確率を引き算します。  

```{r fig12, echo = FALSE, fig.align="center", fig.height=3, fig.width=4}
knitr::include_graphics(path = "fig/zscore.png")
```  

<div class="alert alert-info">
- `pnorm()`関数について詳しくは`?pnorm`とコンソールに入力してヘルプを確認してください。
- `pnorm()`関数の第一引数には求めたい値，第二引数の`mean`には正規分布の平均，第三引数の`sd`には標準偏差を入力します。今回は標準正規分布なので，平均は0，標準偏差は1を指定します。
</div>
<br>  

```{r}
pnorm(1.96, mean = 0, sd = 1) - pnorm(0, mean = 0, sd = 1)
```  

- 手順1で計算した確率と同じような値が計算されていることが確認できます。  

## 4.2.2 正規分布を仮定したときの平均の標本分布(p.109-111)  {-} 

- 「平均の標本分布」はRでの演習はありません。  
<br>
- 母集団分布が正規分布である場合には，その標本分布自体が正規分布となることが知られています。  
<br>
- 図4-6について，Rでのシミュレーションを通して確認してみましょう。<u>ただし，母集団分布を**標準正規分布**と仮定します。</u>)  
<br>
<div class="alert alert-info">
Rで正規分布に従う乱数を生成するには，`rnorm()`関数を利用します。`rnorm(発生させる乱数の数，母集団の平均値，標準偏差)`を与えることで，正規分布に従う乱数を生成することができます。  
</div>
<br>
- シミュレーションの手順  
  1. 正規分布に従う乱数を生成し，その平均$\bar{x}$を計算します。  
  1. 1.の手順を1000回繰り返し，1000個の標本平均$\bar{x}$を求めます。  
  1. 求めた標本平均$\bar{x}$の平均が，母集団の平均値に一致するか，母集団の標準偏差の$1 / \sqrt{N}$倍に案っているか確認します。  
<br>
- $N = 1$のとき  

  - 標準正規分布に従う乱数を1個取り出す作業を1000回繰り返し，`std.norm.1`というオブジェクトに代入します。  

```{r}
set.seed(1234)
std.norm.1 <- NA
for(i in 1:1000){
  std.norm.1[i] <- rnorm(1, mean = 0, sd = 1)
}
```  

  - $N = 1$の時は平均を求める必要がない(1で割ることになる)ので，`std.norm,1`がそのまま標本平均となります。  
  <br>
  - 標本平均$\bar{x}$の平均と標準偏差を求めます。  

```{r}
mean(std.norm.1)
sd(std.norm.1)
```  

  - 標本平均$\bar{x}$の平均は0，標準偏差は$\frac{1}{\sqrt{1}} = 1$に近い値となっていることがわかります。  



- 得られた1000個の標本平均をヒストグラムで示します。  

```{r fig13, fig.align="center"}
hist(std.norm.1, freq = FALSE, xlim = c(-4,4))
```  

- 標本平均$\bar{x}$のヒストグラムは，左右対称の釣り鐘型になっています。  
</br>
</br>
- $N = 3$のとき

  - 乱数を3個取り出す作業を1000回繰り返し，`std.norm.3`というオブジェクトに代入します。  

```{r}
set.seed(1234)
std.norm.3 <- matrix(NA, ncol = 3, nrow = 1000)
for(i in 1:1000){
  std.norm.3[i, ] <- rnorm(3, mean = 0, sd = 1)
}
```  

  - コンソールに`std.norm.3`と直接入力すると，乱数が確認できます。  
  <br>
  - 次に，3個の乱数の標本平均を求め，`std.norm.3_mean`というオブジェクトに代入します。データとしては，行方向に平均をとることと同じなので，`rowSums()`関数を用います。  

<div class="alert alert-info">
行列形式のデータで平均を求めるときには，行平均は`rowMeans()`関数，列平均は`colMeans()`関数を使います。   
</div>

```{r}
std.norm.3_mean <- rowMeans(std.norm.3)
```  

  - 最後に標本平均$\bar{x}$の平均と標準偏差を求めます。  
  
```{r}
mean(std.norm.3_mean)
sd(std.norm.3_mean)
```  

  - 標本平均$\bar{x}$の平均は0付近，標準偏差は$1 / \sqrt{3}$の`r round(1 / sqrt(3), 3)`に近い値となっています。  

- 得られた1000個の標本平均をヒストグラムで示します。  

```{r fig14, fig.align="center"}
hist(std.norm.3_mean, freq = FALSE, xlim = c(-4,4))
```  

- $N = 1$の時と比較して，母集団平均$\mu$に集中した形になっていることがわかります。  
<br>
- $N = 10$のとき

  - 乱数を10個取り出す作業を1000回繰り返し，`std.norm.10`というオブジェクトに代入します。  

```{r}
set.seed(1234)
std.norm.10 <- matrix(NA, ncol = 10, nrow = 1000)
for(i in 1:1000){
  std.norm.10[i, ] <- rnorm(10, mean = 0, sd = 1)
}
```  

  - 10個の乱数の標本平均を求め，`std.norm.10_mean`というオブジェクトに代入します。  

```{r}
std.norm.10_mean <- rowMeans(std.norm.10)
```  

  - 最後に標本平均$\bar{x}$の平均と標準偏差を求めます。  
  
```{r}
mean(std.norm.10_mean)
sd(std.norm.10_mean)

sqrt(mean((std.norm.10_mean - mean(std.norm.10_mean))^2))
```  

  - 標本平均$\bar{x}$の平均は0付近，標準偏差は$1 / \sqrt{10}$の`r round(1 / sqrt(10), 3)`に近い値となっています。  
  
- 得られた1000個の標本平均をヒストグラムで示します。  

```{r fig15, fig.align="center"}
hist(std.norm.10_mean, freq = FALSE, xlim = c(-4,4))
```  
<br>

<br>

- 平均50，標準偏差10の正規分布の正規母集団からサンプルをとったとき，その平均$\bar{x}$が母集団平均50から1以上離れた値をとる確率(N = 25のとき)  

<div class="alert alert-info">
`pnorm()`関数はある値までの確率を求めます。ある値以上の確率を求めるには，すべての確率を足し合わせると1になるという性質を利用します。  
</div>

```{r}
pnorm(49, mean = 50, sd = 10 / sqrt(25)) + (1 - pnorm(51, mean = 50, sd = 10 / sqrt(25)))
```  

- 教科書の変形($Prob(z > .5) \times 2$)を使って以下のコードでも同じ結果となります。  

```{r}
(1 - pnorm(0.5, mean = 0, sd = 1)) *2
```  

<details>
<summary>
補足(クリックすると説明が表示されます)
</summary>
- これまで`pnorm()`関数で上側確率を求めるには，1から引く方法のみを紹介してきました。  
- `pnorm()`関数には，`lower.tail`という引数があります。この引数はデフォルトの設定(何も指定しないと，デフフォルトの設定になります)で，下側確率を求めるように指定されています。  
- 上側確率を求めたいときには，`lower.tail = FALSE`と指定してください。  
<br>
-以下の2つのコードは同じ結果が得られます。  

```{r}
1 - pnorm(1.96)
pnorm(1.96, lower.tail = FALSE)
```  

</details>  

## 4.2.3 逸脱行動データにおける平均の変動(p.111)   {-}

- 逸脱行動データを読み込みます。  

```{r}
dat <- read.csv(file = "data/itsudatsu_data.csv")	
dat
```  

- 男子の変化量を`diff_M`，女子の変化量を`diff_F`というオブジェクトに代入します。    

```{r}
diff_M <- dat$diff[dat$sex == 1]
diff_M
diff_F <- dat$diff[dat$sex == 2]
diff_F
```  

- それぞれの変化量の不偏分散の平方根$s ^{\prime}$を使って，平均の標準誤差を求めます。  
<br>
- 男子における平均の標準誤差の推定値  

```{r}
sd(diff_M) / sqrt(20)
```  

- 女子における平均の標準誤差の推定値  

```{r}
sd(diff_F) / sqrt(20)
```  



## 4.3.1 相関係数の標本分布  {-}    

- 「2変数の確率モデル」「2変数正規分布モデル」のRでの演習はありません。  

- (4.20)式を図で表します。サンプルサイズは20,50,100,200,300の5つで計算をしています。  

```{r fig16, fig.align="center"}
ro <- seq(-1, 1,by = .01)
plot((1 - ro^2) / sqrt(20) ~ ro, type = "l", xlab = "母集団相関係数", ylab = "標準誤差", col = 1)
lines((1-ro^2) / sqrt(50) ~ ro, col = 2)	
lines((1-ro^2) / sqrt(100) ~ ro, col = 3)
lines((1-ro^2) / sqrt(200) ~ ro, col = 4)
lines((1-ro^2) / sqrt(300) ~ ro, col = 5)
legend("topright", legend = c("N = 20","N = 50","N = 100","N = 200","N = 300"), col = c("1","2","3","4","5"), lty = 1)
```  

- $r$の標準誤差は，$\rho$の絶対値が小さいほど小さく，$N$の平方根に比例して小さくなることがわかります。  

- 逸脱行動データを使って相関係数$r$の標準誤差の計算を行います。  
  - 20人の男子における小6と中2のときの逸脱行動得点の間の相関係数を計算します。  

```{r}
dat <- read.csv(file = "data/itsudatsu_data.csv")
itsu_M_6th <- dat$Grade_6th[dat$sex == 1]
itsu_M_8th <- dat$Grade_8th[dat$sex == 1]
cor(itsu_M_6th, itsu_M_8th)
```  

- 相関係数は$r = .60$であることが確認できました。  
- この値を(4.20)式の母集団相関係数$\rho$の推定値として用います。  

```{r}
(1 - cor(itsu_M_6th, itsu_M_8th)^2) / sqrt(20)
```  

- 相関係数$r$の標準誤差の推定値が計算できました。  

## 4.3.2 相関係数に関する確率計算(p.115-117)   {-}

- フィッシャーのZ変換は以下の(4.21)式で定義されます。  

$$
Z = \tanh ^{-1}r = \frac{1}{2}\ln\frac{1 + r}{1 - r}\tag{4.21}\\
$$  

- 相関係数$r = .8$の時のZ変換値を計算してみましょう。  

<div class="alert alert-info">
(4.21)式の$\ln$は自然対数を表すので，Rでは`log()`関数を使います。 
</div>  

```{r}
(1 / 2) * log((1 + 0.8) / (1 - 0.8))
```  

- 図4-9中の値と同様の結果が得られました。  
<br>

- 図4-9を描いていきます。  
- (4.21)式を`fisher.z()`関数という名前で新たに定義します。とる引数は`r`としています。    

```{r}
fisher.z <- function(r){
		(1 / 2) * log((1 + r) / (1 - r))
  }
```  

```{r fig17, fig.align="center"}
x <- seq(-1, 1, length = 50)
plot(fisher.z(x) ~ x, type = "l", xlab = "相関係数", ylab = "Z", main = "フィッシャーのZ変換")
```  

- Z変換を行うことで正規分布に近似できるか，シミュレーションで確認してみます。  

  1. 平均がそれぞれ50，標準偏差がそれぞれ10，母集団相関係数$\rho = .6$の2変数正規分布から$N = 100$のサンプルをとる作業を1000回繰り返します。 
  1. 発生させた乱数から相関係数$r$を計算し，Z変換を行う。

<div class="alert alert-info">
2変量正規分布に従う乱数を発生させるには`MASS`パッケージの`mvrnorm()`関数を使用しています。`mvrnorm()`関数の使い方については今回詳しく説明しませんので，`?mvrnorm`でヘルプを確認してください。
</div>  

- 乱数を発生させ，計算した相関係数$r$を`random_cor`というオブジェクトに代入します。    

```{r}
set.seed(1234)
library(MASS)
random_r <- list()
random_cor <- NA
for(i in 1:1000){
  random_r[[i]] <- mvrnorm(100, mu = c(50, 50), Sigma = matrix(c(10*10, 10*10*0.6, 10*10*0.6, 10*10), ncol = 2))
  random_cor[i] <- cor(random_r[[i]][,1], random_r[[i]][,2])
}  
```  

- 1000個の相関係数$r$のヒストグラムを確認してみます。  

```{r}
hist(random_cor, freq = FALSE, xlim = c(-1,1))
```  

- `random_cor`の値をZ変換し，`random_Z`というオヴジェクトに代入します。  

```{r}
random_Z <- (1 / 2) * log((1 + random_cor) / (1 - random_cor))
```  

- `random_Z`をヒストグラムで確認します。  

```{r}
hist(random_Z, freq = FALSE, xlim = c(-0.5,2))
```  

- `random_Z`の平均，標準偏差と(4.22)，(4.23)式の値を比較します。  

```{r}
mean(random_Z)
(1 / 2) * log((1 + 0.6) / (1 - 0.6))
```  

```{r}
sd(random_Z)
1 / (sqrt(100 - 3))
```  

- 発生させた乱数と(4.22)，(4.23)式で計算される値が同様のの値となっていることが確認できます。  


- $\rho = .6$の2変量正規母集団から$N = 100$のサンプルがとられるとき，$r > .7$となる確率  
- $\mu _{Z}$と$\sigma _{Z}$の値はさきほど計算をしました。  
- $r > .7$の範囲をZ変換すると，  

```{r}
(1 / 2) * log((1 + 0.7) / (1 - 0.7))
```  

となります。  
<br>

- 教科書の式をコードで記述すると以下になります。  

```{r}
1 - pnorm(1.706, mean = 0, sd = 1)
```  

- 教科書と同じ値が計算できました。  

## 4.3.3 回帰分析のための確率モデル(p.118-119) {-}

- 「回帰分析のための確率モデル」はRでの演習はありません  

- 逸脱行動データを用いて，回帰係数$b$の標準誤差を計算します。  
<br>
- データを読み込み，男子のデータのみを抽出し，`reg_M`というオブジェクトに代入します。  


```{r}
dat <- read.csv(file = "data/itsudatsu_data.csv")
reg_M <- dat[dat$sex == 1,]
```  

- `lml()`関数を使って小6のときの逸脱行動得点から，中2の時の得点を予測するときの回帰係数を求めます(`lm()`関数については，第3章で詳しく説明を行う予定です)。  

```{r}
reg <- summary(lm(itsu_M_8th ~ itsu_M_6th ,data = reg_M))	
reg
```  

- 出力結果の`Coefficients`の`Estimate`の列から，回帰係数$b$は0.5848であることがわかります。  
- `lm()`関数の出力では，標準誤差も`Std.Error`の列に表示されます。  

- (4.27)式で実際に計算してみましょう。  

  - 男子における小6の逸脱行為データの標準偏差を`sd_G6`，中二の標準偏差を`sd_G8`に代入します。  
  - (3.26)式は以下の式です。  

$$
s ^{\prime} _{e} = s _{e} \sqrt{N / (N - 2)}
$$  

  - (3.26)式の計算結果を`se_prime`というオブジェクトに代入します。  

```{r}
sd_G6 <- sqrt(mean((reg_M$Grade_6th -mean(reg_M$Grade_6th))^2))
sd_G8 <- sqrt(mean((reg_M$Grade_8th -mean(reg_M$Grade_8th))^2))
se_prime <- sd_G8 * sqrt(1 - cor(reg_M$Grade_6th, reg_M$Grade_8th) ^2) * sqrt(20 / (20 - 2))
se_prime / (sqrt(20) * sd_G6)
```  

- 教科書と同じ結果が得られました。  

## 4.4 4章演習問題  {-}

### 問題1  {-}

- 4.1.1では$N = 5$，$\pi = .6$としたときの正答者$w$の標本分布を描きました。
- $N = 5$は変更せず，$\pi$を，$\pi = .8$にした時の図を描いてください。  
<br>
- 対応する章：4.1.1 比率の標本分布 　

### 問題2 {-}  

- $N = 5$，$\pi = .8$としたときの正答者$w$の標本分布の平均を求めてください。  
<br>
- 対応する章：4.1.2 確率分布の平均 　 　

### 問題3 {-}  

- (4.4)式から(4.5)式が導けるか，手を動かして式を変形してみましょう。  

この問題は提出する必要はありません。  
<br>
- 対応する章：4.1.2 確率分布の平均 　 


### 問題4 {-}  

- 4.1.6で定義した`Standard.error()`関数を使って，母集団比率$\pi = .5$の時について，$N$が1,3,10,100のときに標準誤差がどのように変化するか確認してください。  
- 値が計算出来たら，図4-4(p.101)と計算結果が対応しているか確認してください。  

<div class="alert alert-info">
`Standard.error()`関数は以下のコードで定義します。  
```{r}
Standard.error <- function(N, PI){
  sqrt(PI * (1 - PI) / N)
}
```  
</div>
<br>
- 対応する章：4.1.6 標準誤差に基づくサンプルサイズの決定 　

### 問題5 {-}  

- 比率$p$の標準誤差を$.01$以下にするのに必要なサンプルサイズを求めてください。ただし，教科書p.101にあるとおり，$\pi$には$.5$を代入してください。  
<br>
- 対応する章：4.1.6 標準誤差に基づくサンプルサイズの決定　

### 問題6 {-}

- `pnorm()`関数を使って以下の確率を計算しましょう。  
  1. $Prob(z > 1.96)$  
  1. $Prob(|z| < 1.96)$  
  1. $Prob(|z| > 1.96)$  
<br>
- 対応する章：4.2.1 正規分布の確率の求め方  


### 問題7 {-}  

- 平均50，標準偏差10の正規分布の正規母集団から$N = 400$のサンプルをとったとき，その平均$\bar{x}$が母集団平均50から1以上離れた値をとる確率を計算してください。  
<br>
- 対応する章：4.2.2 正規分布を仮定したときの平均の標本分布  


### 問題8 {-}  

- 相関係数が$r = .0, .2, .4, .6, .8$のときのZ変換値を計算してください。  
<br>
- 対応する章：4.3.2 相関係数に関する確率計算 　

### 問題9 {-}  

- $\rho = .8$の2変量正規母集団から$N = 100$のサンプルがとられるとき，Z変換後の平均$\mu_{Z}$と標準偏差$\sigma _{Z}$を求めてください。  
<br>
- 対応する章：4.3.2 相関係数に関する確率計算 　

### 問題10 {-}  

- 問題2の計算結果を，シミュレーションで確かめてみましょう。  
- 乱数を発生させ，計算した相関係数$r$を`random_exe`というオブジェクトに代入します。    

```{r}
set.seed(1234)
library(MASS)
random_r <- list()
random_exe <- NA
for(i in 1:1000){
  random_r[[i]] <- mvrnorm(100, mu = c(50, 50), Sigma = matrix(c(10*10, 10*10*0.8, 10*10*0.8, 10*10), ncol = 2))
  random_exe[i] <- cor(random_r[[i]][,1], random_r[[i]][,2])
}  
```  

1. 1000個の相関係数$r$のヒストグラムを示してください。  
1. `random_exe`の値をZ変換し，`random_Z_exe`というオブジェクトに代入してください。  
1. `random_Z_exe`の平均と標準偏差を求めてください。  
<br>
- 対応する章：4.3.2 相関係数に関する確率計算 　
