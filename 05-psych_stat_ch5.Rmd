# 第5章 推定と検定の考え方 {-}

## 5.1.1 不偏推定量(p.128-129)  {-} 

- (5.1)式は，標本分散$s ^{2}$の期待値$E(s ^{2})$が，母集団分散$\sigma ^{2}$よりもわずかに小さくなることを意味しています。  

$$
E(s ^{2}) = \frac{N - 1}{N} \sigma ^{2} \tag{5.1}\\
$$  

- (5.1)式は母集団分布の種類によらないことをシミュレーションで確認してみましょう。  

### 母集団が**(標準)正規分布**の場合 {-}  

- 正規分布は平均$\mu$と分散$\sigma ^{2}$で特徴づけられる分布です。特に，平均$\mu = 0$，分散$\sigma ^{2} = 1$の時の正規分布を標準正規分布と呼びます。  
  - 正規分布の詳しい説明は4章を参考にしてください。  
<br>

- シミュレーションの手順  

<div class="alert alert-info">
1. 正規分布に従う乱数を発生させる`rnorm()`関数を使って，標準正規分布に従う乱数を生成し，`sim_norm_value`というオブジェクトに代入する。  
  - `rnorm()`関数は，`rnorm(生成したい乱数の数, mean = 母集団の平均の値, sd = 母集団の標準偏差の値)`という引数を指定します。今回は標準正規分布に従う乱数を100個生成するので，`rnorm(100, mean = 1, sd = 0)`というコードになります。  
2. `sim_norm_value`の分散を計算し，`sim_norm_var`というオブジェクトに代入する。
3. 上記の手順をfor文を使い1000回繰り返す。  
4. 1000個の`sim_norm_var`の期待値を計算する。  
</div>  

- 標準正規分布に従う100個の乱数を生成し，分散を求める作業を1000回繰り返します。  

```{r}
set.seed(1234)
sim_norm_value <- matrix(NA, nrow = 1000, ncol = 100)
sim_norm_var <- NA

for(i in 1:1000){
  sim_norm_value[i,] <- rnorm(100, mean = 0, sd = 1)
  sim_norm_var[i] <- mean((sim_norm_value[i,] - mean(sim_norm_value[i,]))^2)
}
```  

- 1000回繰り返したうちの1回目の乱数をヒストグラムで確認します。  

```{r fig.align = "center"}
hist(sim_norm_value[1,])
```  

- 平均が0付近になっていることが確認できます。  
<br>

- コンソールに`sim_norm_var`と入力すると，計算された分散が1000個表示されます。  
<br>  

- `sim_norm_var`の期待値を計算します。  

```{r}
mean(sim_norm_var)
```  

- 乱数を生成する際に，母集団の分散は1としました。教科書の記述通り標本分散の期待値は母集団分散よりもわずかに小さくなりことが確認できます。  
- (5.1)式の関係が成り立っているか確認しましょう。今回のサンプルサイズ$N$は100です。  

$$
E(s ^{2}) = \frac{N - 1}{N} \sigma ^{2} \tag{5.1}\\
$$  

```{r}
((100 - 1) / 100) * 1
```  

- ほぼ一致する値となりました。  


### 母集団が**2項分布**の場合  {-}  

- 2項分布は「成功確率$\pi$の試行を独立に$N$回繰り返したときの成功数$w$の確率を与える分布」(教科書p96)でした。  
<br>

- シミュレーションの手順  

<div class="alert alert-info">
1. 2項分布に従う乱数を発生させる`rbinom()`関数を使って2項分布に従う乱数を生成し，`sim_binom_value`というオブジェクトに代入する。  
  - `rbinom()`関数は，`rnorm(生成したい乱数の数, size = 試行数, prob = 成功確率)`という引数を指定します。今回は試行数$N = 5$，成功確率$\pi = .6$の2項分布に従う乱数を100個生成します。よって，`rbinom(100, size = 5, prob = 0.6)`というコードになります。  
2. `sim_binom_value`の分散を計算し，`sim_binom_var`というオブジェクトに代入する。  
(以下同様の手順を繰り返す)  
</div>  

- 試行数$N = 5$，成功確率$\pi = .6$の2項分布に従う100個の乱数を生成し，分散を求める作業を1000回繰り返します。  

```{r}
set.seed(1234)
sim_binom_value <- matrix(NA, nrow = 1000, ncol = 100)
sim_binom_var <- NA

for(i in 1:1000){
  sim_binom_value[i,] <- rbinom(100, size = 5, prob = 0.6)
  sim_binom_var[i] <- mean((sim_norm_value[i,] - mean(sim_norm_value[i,]))^2)
}
```  

- 1000回繰り返したうちの1回目の乱数を棒グラフで確認します(軸に日本語を使っているので，Macの人は文字化けする可能性があります。3章3.1.1や4章4.1.1で対処法を載せているので確認してください)。  

```{r fig.align = "center"}
barplot(table(sim_binom_value[1,]), ylim = c(0, 50), xlab = "成功数w", ylab = "度数")
```  

- 試行数$N = 5$，成功確率$\pi = .6$の2項分布に従うので，成功数$w$は0から5までを取ります。  
- 成功確率$\pi$が0,6なので，成功数$w$は3が最も多く出現するはずですが，シミュレーションなので今回は4が最も多く出現しています。`sim_binom_value[1,]`を`sim_binom_value[2,]`や`sim_binom_value[3,]`などに変更して他の乱数の棒グラフを確認してみてください。  
  - ここの数字は1000回繰り返した乱数の順番を表しています。    
<br>

- 2項分布の母集団分散$\sigma ^{2} _{w}$は教科書p.99の(4.8)式に従って計算することができます。(4.8)式は標準偏差を表しているので，ルートをとることで分散になります。  

$$
\sigma ^{2} = N \pi(1 - \pi)
$$  

- よって，試行数$N = 5$，成功確率$\pi = .6$に従う2項分布の分散は以下の値になります。    

```{r}
5 * 0.6 * (1 - 0.6)
```  


- `sim_binom_var`の期待値を計算します。  

```{r}
mean(sim_binom_var)
```  

- 母集団分散$\sigma ^{2} _{w}$よりも標本分散の期待値が小さくなっていることがわかります。  
- (5.1)式の関係が成り立っているか確認しましょう。

```{r}
((5 - 1) / 5) * 1.2
```  

- ほぼ一致する値となりました。  
<br>

- 以上から，母集団分布の種類によらず(5.1)式の関係が成り立っていることが確認できました。  

## 5.1.2 最尤法 {-}  

- (5.3)式について，母数$\pi$を変化させて尤度を計算してみましょう。  

$$
L(\pi) = \pi ^{3}(1 - \pi) ^{2}\tag{5.3}\\
$$  

- $\pi = 0.2$の時  

```{r}
0.2 ^3 * (1 - 0.2) ^2
```  

- $\pi = 0.4$の時  

```{r}
0.4 ^3 * (1 - 0.4) ^ 2
```  

- $\pi = 0.6$の時  

```{r}
0.6 ^3 * (1 - 0.6) ^ 2
```  

- 図5-1と同じ値が計算されていることがわかります。  

<br>

- 毎回コードを入力するのは面倒なので，一度に計算できるように(5.3)式を`yuudo()`関数として新たな関数を定義します。  
  - 引数の`PI`は(5.3)式の母数$\pi$に対応します。  

```{r}
yuudo <- function(PI){
  PI ^3 * (1 - PI) ^2
}
```  

- $\pi = 0.2$の時  

```{r}
yuudo(0.2)
```  

- 同じ値が計算できました。  
- ベクトルでまとめて計算します。  

```{r}
yuudo(c(0.2, 0.4, 0.6, 0.8))
```  

- $\pi = 0.6$の時が値が大きいことがわかります。  

<br>

- 図5-1を書いてみましょう。
- 最初のコードは第4章4.1.1で図を書いたときと同じように，0から1まで0.01刻みのベクトルを作成しています。  

```{r fig.align="center"}
x <- seq(0, 1, 0.01)
plot(x, yuudo(x), 
     type = "l",
     las = 1,
     bty = "l",
     tcl = 0.2,
     yaxp = c(0, 0.04, 4),
     ylim = c(0, 0.04),
     xlab = expression(pi),
     ylab = "尤度")
```  

## 5.1.3 標準誤差による推定制度の評価 {-}  

- (5.7)式の計算をします。  

```{r}
(1 - 0.5 ^2) / sqrt(100)
```  

## 5.1.4 標準誤差に基づくサンプルサイズの決定 {-}  

- 標準誤差を.05以下に抑えたいとき  

$$
\begin{align}
\frac{1 - r ^{2}}{\sqrt{N}} &\leq .05\\
1 - r ^{2} &\leq .05 \times \sqrt{N}\\
.05 \times \sqrt{N} &\geq 1 - r ^{2}\\
\sqrt{N} &\geq \frac{1}{.05} \times (1 - r ^{2})\\
N &\geq 400(1 - r ^{2}) ^{2}\\
\end{align}
$$  

- $r = .5$程度の大きさの相関が見込まれるとき  

```{r}
400 * (1 - 0.5^2) ^2
```  

## 5.2.1 検定統計量の帰無分布と棄却域 {-}  

- $N = 20$，母集団相関係数$\rho = 0$の時の相関係数$r$の標本分布を示した図5-2を書きます。  。  
  - 教科書p.114には「相関係数$r$の標本分布の確率密度関数は数学的にかなり複雑になる」とありますが，Rでは追加のパッケージである`SuppDists`パッケージをインストールすることで簡単に計算することができるようになります。  
  - `SuppDist`パッケージを使うには初回にインストールを行う必要があります。以下のコード，もしくはパッケージタブにある`install`ボタンからパッケージをインストールしてください。  


  
```{r eval = FALSE}
install.packages("SuppDists")
```  

- 一度インストールすればその後は上記のコードを入力する必要はありません。  
<br>

- インストールしたパッケージを読み込みます。この作業はインストールと違い，パッケージを使うたびに行う必要があります。`library()`関数で読み込まないとパッケージが使えないので注意してください。  

```{r}
library(SuppDists)
```  

- 正規分布の確率密度を求めるには，`norm`の`density`(密度)の略で`dnorm()`関数が用意されています。ピアソンの相関係数$r$の標本分布の確率密度を求めるには，`SuppDists`パッケージの`dPearson()`関数を使います。  

<div class="alert alert-info">
- `dPearson()`関数は，`dPearson(標本相関係数$r$，N = サンプルサイズ, rho = 母集団相関係数)`を引数に指定します。  
- 図5-2は母集団相関係数$\rho = 0$，サンプルサイズ$N = 20$なので，`N = 20,rho = 0.0`と引数を指定します。  
</div> 

- 図5-2を書いていきましょう。  

```{r fig.align="center"}
x <- seq(-1, 1, 0.01)
plot(x, dPearson(x, N = 20, rho = 0.0), 
     type = "l",
     las = 1,
     bty = "l",
     tcl = 0.2,
     ylim = c(0, 2),
     yaxp = c(0, 2, 4),
     xlim = c(-1, 1),
     xaxp = c(-1, 1, 10),
     xlab = "r",
     ylab = "確率密度")
```  

<br>

- $|r| > .444$の範囲に含まれる確率が約5%であることを確認しましょう。  
- ある範囲に含まれる確率を求めるには密度関数を積分することで計算することができます。  
  - Rで積分をするには`integrate()`関数を使います。  
  
<div class="alert alert-info">
- `integrate()`関数は，`integrate(積分したい関数，lower = 範囲の下限，upper = 範囲の上限)`を引数に指定することで計算することができます。   
</div> 

```{r}
rho_0_pdf_inte <- integrate(dPearson, N = 20, rho = 0.0, lower = -0.444, upper = 0.444)
rho_0_pdf_inte$value
```  

- $|r| < 0.444(-0.444 < r < 0.444)$の範囲に全体の0.95...，つまり約95%が含まれていることがわかりました。  
- 確率は全体で1なので，1から$|r| < 0.444$に含まれる範囲を引くと$|r| > 0.444(r < -0.444, 0.444 < r)$の範囲を求めることができます。  

```{r}
1 - rho_0_pdf_inte$value
```  

- $|r| > 0.444$に含まれる確率が約5%であることが確認できました。  

<br>
<br>

- 第4章4.2.1の演習と同様に，`SuppDists`パッケージには下側確率を求める`pPraeson()`関数があります。`pPearson()`関数を使って$|r| > .444$の範囲に含まれる確率が約5%であることを確認しましょう。  

```{r}
pPearson(0.444, N = 20, rho = 0.0) - pPearson(-0.44, N = 20, rho = 0.0)
1 - (pPearson(0.444, N = 20, rho = 0.0) - pPearson(-0.44, N = 20, rho = 0.0))
```  

- 確率密度関数を積分して確認した時と同じように，$|r| > 0.444$に含まれる確率が約5%であることが確認できました。  

<br>

- これまで$|r| > 0.444$に含まれる確率が約5%であることを確認しました。逆に，全体の5%となる確率に対応する標本相関係数$r$の値を確認することもできます。  
- `SuppDists()`関数の`qPearson()`関数で全体の97.5%と2.5%点に対応する標本相関係数$r$が0.444と-0.444なのかを確認してみましょう。  

<div class="alert alert-info">
- `qPearson()`関数は，`qPearson(求めたい確率，N = サンプルサイズ，rho = 母集団相関係数)`を引数に指定することで計算することができます。   
</div>  

```{r}
qPearson(0.975, N = 20, rho = 0.0)
qPearson(0.025, N = 20, rho = 0.0)
```  

- それぞれ0.444と-0.444に対応していることが分かります。  


## 5.2.2 有意水準 {-}  

- $N = 20$の例において，$|r| > .561$の範囲に含まれる確率が1%(0.01)となることを確認します。  

```{r}
1 - (pPearson(0.561, N = 20, rho = 0.0) - pPearson(-0.561, N = 20, rho = 0.0))
```  

- 約1%となることがわかります。  
<br>

- 付表3を`qPearson()`関数を使って再現してみます。サンプルサイズ4から20まで同じ値になるか確認してみましょう。    
  - 付表3はサンプルサイズ3から始まっていますが，Rでは計算ができないため4から始まっています。  
  - 4から20まで値を一つにまとめたベクトルを作成しています。4から20まで1つずつ値が増えていくベクトルを作成するには`:`記号を使うと便利です。  
  

```{r}
qPearson(0.975, N = 4:20, rho = 0.0)
```  

- 有意水準.05の列と同じ値が確認できます(qPearsonは下側確率を計算するので，求める限界値は片側検定の考え方を用いて97.5%点となります)。  

## 5.2.3 t分布を用いた検定 {-}  

- $t$分布を用いた検定を行ってみましょう。  
- 標本相関係数$r$を(5.8)式の変数$t$に変換します。  

$$
t = \frac{r}{\sqrt{1 - r ^{2}}} \times \sqrt{N - 2}\tag{5.8}\\
$$  

- 逸脱行動データにおける$r = 0.60(N = 20)$の数値例で計算してみましょう。  

```{r}
(0.6 / sqrt(1 - 0.6^2)) * sqrt(20 - 2)
```  

- 自由度$df = 18$の$t$分布をプロットします。  

```{r fig.align="center"}
x <- seq(-4, 4, 0.01)
plot(x, dt(x, df = 18), 
     type = "l",
     las = 1,
     bty = "l",
     tcl = 0.2,
     xlab = "t",
     xaxp = c(-4,4,8),
     ylab = "確率密度")
```  

- 計算で求めた$t = 3.181 \cdots$という値はかなりまれであることがわかります。 

<br>
<br>

- 教科書では付表4を使って有意かどうかの判定をしています。  
- Rでは自由度$N - 2$の$t$分布において，先ほど計算した$t$値(3.181...)が分布の何%に位置するか計算することができます。  
  - 計算には`pt()`関数を使います。  

<div class="alert alert-info">
- `pt()`関数は，`t`分布の下側確率(`p`robability)を略して`pt()`という名前になります。  
- `pt()`関数では，`pt(確率を求めたいt値, df = 自由度)`という引数を指定します。  
  - 上側確率を求めたい場合には，引数`lower.tail = FALSE`を追加で与えます。
  - `lower.tail = FALSE`を引数に指定した場合と，指定せずに1から引いた値はおなじ値となります。  
</div> 

  
```{r}
1 - pt((0.6 / sqrt(1 - 0.6^2)) * sqrt(20 - 2), df = 18)
pt((0.6 / sqrt(1 - 0.6^2)) * sqrt(20 - 2), df = 18, lower.tail = FALSE)
```  

- 5%水準(上側確率0.025)よりも小さいので，5%水準の両側検定で有意になります。また，この値は1%水準(上側確率0.005)よりも小さいので，1%水準の両側検定でも有意になります。  

<br>
<br>

- Rでは無相関仮説の検定を行う`cor.test()`関数があります。  
- `cor.test()`関数を使って検定を行ってみましょう。  

<br>

- まずは男子の逸脱行動データを読み込みます($r = 0.60, N = 20$)。  

```{r}
dat <- read.csv(file = "data/itsudatsu_data.csv")
dat_M <- subset(dat, sex == 1)
nrow(dat_M)
cor(dat_M$Grade_6th, dat_M$Grade_8th)
```  

<div class="alert alert-info">
- `cor.test()`関数は，`cor.test(変数x,変数y)`という引数を指定します(そのほかの引数に関しては，`?cor.test`とコンソールに入力してください)。  
</div>  

```{r}
cor.test(dat_M$Grade_6th, dat_M$Grade_8th, alternative = "two.side")
```  

- 実行結果のうち，`t = `は$t$値を表します。今回は正確な標本相関係数の値が使われているので，$r = 0.6$で計算した時よりも$t$の値よりも少し小さくなっています。  
- 同じ結果になるかは以下のコードで確認できます。  

```{r}
cor_res <- cor(dat_M$Grade_6th, dat_M$Grade_8th)
(cor_res / sqrt(1 - cor_res^2)) * sqrt(20 - 2)
```  

- `df = `は自由度を表します。今回は$N = 20$だったので，自由度は$df = N - 2$の18です。  
- `p-value`はp値を表します。  

- この値は先ほど`pt()`関数で計算した上側確率を2倍したものになっています。`pt()`関数では，$t > 3.181...$の確率しか求めていませんでしたが，両側検定では$t < -3.181...$の確率も含まれるためです。  
<br>

- p値が5%水準($\alpha = .05$，1%水準($\alpha = .01$)よりも小さいので1%水準で有意であることがわかります。  

## 5.3.1 検定力の求め方 {-}  

- $r$を$Z$変換した変数$Z$は以下の$\mu_{Z}, \sigma _{Z}$を持った正規分布で近似できます。    

$$
\begin{align}
\mu _{Z} &= \tanh ^{-1}\rho = \frac{1}{2}\ln\frac{1 + \rho}{ 1 - \rho}\\
\sigma _{Z} &= \frac{1}{\sqrt{N - 3}} 
\end{align}
$$  

- 教科書では$\rho = .4$で計算をしています。  

```{r}
mu_rho0.4 <- (1/2) * log((1 + 0.4)/ (1 - 0.4))
sigma_rho0.4 <- 1 / (sqrt(20 - 3))
mu_rho0.4
sigma_rho0.4
```  

- また，棄却の限界値$r = \pm.444$を$Z$変換すると

```{r}
Z_U <- (1 / 2) * log((1 + 0.444) / (1 - 0.444))
Z_L <- (1 / 2) * log((1 - 0.444) / (1 + 0.444))
Z_U
Z_L
```  

- $Z = \pm .477$となります。  
<br>

- 正規分布における確率を計算する`pnorm()`関数を使って確率を計算します。  
- 求める確率は$Z > 0.477$となる上側確率と，$Z < -0.477$となる下側確率なので，$Z = 0.477$の場合には1から`pnorm()`関数の結果を引いてあげる必要があります(もしくは，`lower.tail = FALSE`という引数を追加してください)。  

```{r}
1 - pnorm(Z_U, mean = mu_rho0.4, sd = sigma_rho0.4)
pnorm(Z_L, mean = mu_rho0.4, sd = sigma_rho0.4)
```  

- 2つの結果を足すことで検定力を求めることができます。  

```{r}
1 - pnorm(Z_U, mean = mu_rho0.4, sd = sigma_rho0.4) + pnorm(Z_L, mean = mu_rho0.4, sd = sigma_rho0.4)
```  

- 教科書と同じ結果が得られました。  


<br>
<br>

- 教科書では，付表の標準正規分布表を使うために，$Z$の値を標準化し$z$としています。`pnorm()`関数の引数`mean`と`sd`が変わっています。    

```{r}
z_U <- (Z_U - mu_rho0.4) / sigma_rho0.4
z_L <- (Z_L - mu_rho0.4) / sigma_rho0.4
z_U
z_L

1 - pnorm(z_U, mean = 0, sd = 1)
pnorm(z_L, mean = 0, sd = 1)

1 - pnorm(z_U, mean = 0, sd = 1) + pnorm(z_L, mean = 0, sd = 1)
```  

- 得られる結果は同じです。  

## 5.3.2 検定力分析によるサンプルサイズの決定 {-}  

- 5.3.1の手順を`power_cor()`関数として定義します。  
  - 引数には，サンプルサイズ`N`，母集団相関係数$\rho$を指定します。  

```{r}
power_cor <- function(N, rho){
  library(SuppDists)
  r_U <-  qPearson(p = 0.975, N = N, rho = 0)
  r_L <-  qPearson(p = 0.025, N = N, rho = 0)
  mu <- atanh(rho)
  sigma <- 1 / sqrt(N - 3)
  
  pnorm(atanh(r_U), mean = mu, sd = sigma, lower.tail = FALSE) + pnorm(atanh(r_L), mean = mu, sd = sigma)
}
```  

- サンプルサイズ$N = 20$，母集団相関係数$\rho = .4$の時の検定力を計算してみましょう。  

```{r}
power_cor(N = 20, rho = 0.4)
```  

- 5.3.1で計算した検出力と同じ値が得られました。  

<br>
<br>  

- $\rho = .4$の時，サンプルサイズ$N = 100$で検定力がほぼ1に達するか確認しましょう。  

```{r}
power_cor(N = 100, rho = 0.4)
```  

<br>
<br>

- 付図1を書いてみましょう。ただし，$N = 100$と$N = 200$の時とします。    

```{r fig.align="center"}
x <- seq(-1, 1, 0.01)
plot(x, power_cor(N = 100, rho = x), 
     type = "l",
     las = 1,
     bty = "l",
     tcl = 0.2,
     xlim = c(-1,1),
     xaxp = c(-1,1, 10),
     xlab = expression(paste("母集団相関係数", rho)),
     ylab = "検定力",
     col = "blue")
lines(x, power_cor(N = 200, rho = x))
abline(v = seq(-1, 1, 0.2), h = seq(0, 1, 0.2), col = "lightgray", lty = "dotted")
legend("bottomright", legend = c("N = 100","N = 200"), col = c("blue","black"), lty = 1)
```  


## 5.4.1 任意の相関値を帰無仮説とした検定 {-}  

- 図5-5を書いてみます。  
- 図5-5の母集団相関係数$\rho = 0$の値を読み取ると，下側.025に対する値-0.44と上側.025に対する値.44が読み取れます。  
- この値は5.2.1で`qPerson()`関数で求めた値になります。  

<br>

- `qPearson()`関数を使って図5-5を描きます。  

```{r fig.align="center"}
x <- seq(-1, 1, 0.01)[-c(1,201)]
plot(x, qPearson(0.975, N = 20, rho = x), 
     type = "l",
     las = 1,
     bty = "l",
     tcl = 0.2,
     xlim = c(-1,1),
     xaxp = c(-1,1, 10),
     xlab = expression(paste("標本相関係数", r)),
     ylim = c(-1,1),
     yaxp = c(-1,1, 10),
     ylab = "母集団相関係数",
     col = "blue")
lines(x, qPearson(0.025, N = 20, rho = x))
abline(v = seq(-1, 1, 0.2), h = seq(-1, 1, 0.2), col = "lightgray", lty = "dotted")
abline(h = 0)
points(x = qPearson(0.975, N = 20, rho = 0), y = 0, pch = 16)
points(x = qPearson(0.025, N = 20, rho = 0), y = 0, pch = 16)
legend("bottomright", legend = c("下側.025","上側.025"), col = c("blue","black"), lty = 1)
```  

## 5.4.2 信頼区間の算出 {-}  

- 男子の逸脱行動データを用いて母集団相関係数の95%信頼区間の限界値を計算します。  
  - `dat`が読み込まれている場合には，以下のコードは実行する必要はありません。  

```{r}
dat <- read.csv(file = "data/itsudatsu_data.csv")
dat_M <- subset(dat, sex == 1)
nrow(dat_M)
cor(dat_M$Grade_6th, dat_M$Grade_8th)
```  

- (5.13)式，(5.14)式に従って上限下限を計算します。  

$$
\begin{align}
\rho_{L} = \tanh(\tanh ^{-1} r - 1.96 / \sqrt{N - 3}) \tag{5.13}\\
\rho _{U} = \tanh(\tanh ^{-1} r + 1.96 / \sqrt{N - 3}) \tag{5.13}\\
\end{align}
$$  

<div class="alert alert-info">
- $\tanh ^{-1}$は`atanh()`関数で計算することができます。  
</div> 

```{r}
rho_L <- tanh(atanh(cor(dat_M$Grade_6th, dat_M$Grade_8th)) - (qnorm(0.975) / sqrt(20 - 3)))
rho_U <- tanh(atanh(cor(dat_M$Grade_6th, dat_M$Grade_8th)) + (qnorm(0.975) / sqrt(20 - 3)))

rho_L
rho_U
```  

- 母相関係数の95%信頼区間を計算することができました。  

<br>
<br>

- 無相関仮説の検定を行う`cor.test()`関数では，実行結果の中に95%信頼区間を出力してくれています。  

```{r}
cor.test(dat_M$Grade_6th, dat_M$Grade_8th, alternative = "two.side")
```  

- 実行結果の中にある`95 percent confidence interval`の行を見ると，先ほど計算した95%信頼区間と同じ値が表示されています。  

## 5.4.3 信頼区間を利用したサンプルサイズの決定 {-}  

- 付表5を`cor_sample()`関数で計算します。  
  - `cor_sample()`関数は引数に，予想される相関係数`r`と望まれる95%信頼区間の幅`w`を指定します。  

```{r}
cor_sample <- function(r,w){
	temp <- function(N){
		(tanh(atanh(r)+qnorm(0.975)/sqrt(N-3))-
		tanh(atanh(r)-qnorm(0.975)/sqrt(N-3)))-w
		}
	ceiling(uniroot(temp,c(4,10e10))$root)
}
```  

- 予想される相関係数が$r = .5$，信頼区間の幅が.05の時の値を計算します。  

```{r}
cor_sample(r = .5, w = 0.05)
```  

- 付表5とおなじ値が計算されました。  


## 演習問題 {-}

### 問題1 {-}  

- 教科書p130の図5-1では，$N = 5$，$w = 3$の時の母集団比率$\pi$の尤度関数をグラフで表しました。  

- 尤度関数は以下の式です。  

$$
L(\pi) = \pi ^{3} (1 - \pi) ^{2}\\
$$  

- 5.1.2最尤法では，上記の尤度関数を`yuudo()`として以下のコードで定義しました。  

```{r}
yuudo <- function(PI){
  PI ^3 * (1 - PI) ^2
}
```  

- 試行数は$N = 5$のまま，成功数を$w = 4$に変えたとき，尤度関数がどのように変化するか確認します。  

- $N = 5$，$w = 4$の時の母集団比率$\pi$の尤度関数を`yuudo_new()`関数として新たに定義してください。ただし，尤度関数は以下の式で表されます。  

$$
L(\pi) = \pi ^{4} (1 - \pi) ^{1}\\
$$  

- 上記の数式を，`yuudo_new()`関数として定義してください。(ヒント：`yuudo()`関数の数字を変更するだけです)  


### 問題2 {-}

- 以下のコードを実行して，$N = 5$，$w = 4$の時の母集団比率$\pi$の尤度関数を尤度関数をグラフで確認してください。    

```{r eval = FALSE}
x <- seq(0, 1, 0.01)
plot(x, yuudo_new(x), 
     type = "l",
     las = 1,
     bty = "l",
     tcl = 0.2,
     xlab = expression(pi),
     ylab = "尤度")
```  

### 問題3 {-}

- $N = 5$，$w = 4$の時の母集団比率$\pi$の尤度関数において，$\pi = 0.6, 0.8, 1.0$の時の尤度をそれぞれ求めてください。問題2で作成したグラフと値が一致しているか確認してください。  


### 問題4 {-}  

- 教科書では男子の逸脱行動データについて，無相関仮説の検定を行いいました。  
- 女子のデータを使って検定を行ってみましょう。  

- 以下のコードを実行して，女子の逸脱行動データを格納した`dat_F`オブジェクトを作成してください。  

```{r}
dat <- read.csv(file = "data/itsudatsu_data.csv")
dat_F <- subset(dat, sex == 2)
```  

### 問題5 {-}  

- 女子の逸脱行動データにおいて，小6のときの逸脱行動得点と中2のときの逸脱行動得点の相関係数を求めてください。  


### 問題6 {-}  

- 女子の逸脱行動データに対して，`cor.test()`関数を使って無相関仮説の検定を行ってください。  


### 問題7 {-}  

- `dat_F`のデータと，教科書p.141(5.8)式を使って$t$値を計算してください(問題6の結果と一致しているか確認してください)。  



### 問題8 {-}  

- 問題7で計算した$t$値から，`pt()`関数を使って$p$値を求めてください(問題6の結果と一致するか確認してください)。  
<br>

- (ヒント1：`pt()`関数は下側確率を求めるので，`1 - pt(...)`とするか`pt(..., lowwer.tail = FALSE)`としないと上側確率が求められません)
- (ヒント2：`pt()`関数の結果は分布の片側しか示していないので，計算結果を2倍すると`cor.test()`関数の結果と一致します)

  

### 問題9 {-}  

- 女子の逸脱行動データについて，母集団相関係数$\rho$の95%信頼区間を求めてください(問題6の結果と一致することを確認してください)。  

 

